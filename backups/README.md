# Genus Server Backup

This README provides instructions for backing up Genus servers, including PostgreSQL database backups and attachment backups.

## Server Directory
The server directory where Genus data is stored is:

`/srv/genus-wfm`

## Backup Directories
The server backup directory is
`/srv/genus-wfm/backups`
### Postgres Backup Direcotry
`/srv/genus-wfm/backups/postgres_dump`
### Attachment backup directory
`/srv/genus-wfm/backups/attachment_dump`

## PostgreSQL Database Backup

To back up the PostgreSQL database, follow these steps:

1. Change the directory to the backup location:
```bash
cd /srv/genus-wfm/backups
```

2. Execute the following command to take a PostgreSQL database backup:
```bash
sudo su postgres -c "pg_dump --file /srv/genus-wfm/backups/postgres_dump/gmisp_wfm.sql --username postgres --no-password --format=c --blobs --verbose genus_wfm"
```

## Attachment Backup

To back up attachments, follow these steps:

1. Navigate to the attachments directory:
```bash
cd /srv/genus-wfm/backend/public
```

2. Run the following `zip` command to create a compressed backup of the current directory:
```bash
zip -r -9 /srv/genus-wfm/backups/attachment_dump/public_dump.zip ./
```

### Configuring sudoers for Cron Job

In order to run backup scripts in a cron job without being prompted for a password, you need to configure sudoers to allow the following commands:

- `/usr/bin/chown`
- `/usr/bin/su`
- `/usr/bin/rm`

Follow these steps to configure sudoers:

1. Open the sudoers file using the `visudo` command. Do not edit this file directly with a text editor to avoid syntax errors that could lock you out of your system:
```bash
sudo visudo
```

2. Add the following lines to allow your user to run the specified commands without a password prompt. Replace `<username>` with your actual username:

```plaintext
<username> ALL=(ALL) NOPASSWD: /usr/bin/chown
<username> ALL=(ALL) NOPASSWD: /usr/bin/su
<username> ALL=(ALL) NOPASSWD: /usr/bin/rm
```

Replace `<username>` with your actual username. This configuration will enable your user to run `chown` and `su` commands in a cron job without needing a password.

## Restore postgres database

To back up the PostgreSQL database, run this command:

```bash
sudo su postgres -c "pg_restore --username postgres --no-password --dbname genus_wfm --verbose <filepath>"
```

Replace `<filepath>` with your actual filepath.

## Cron JOB for backup
create a cron job for Linux to run multiple commands in one cron job, you can use the following steps:

1. Open the crontab file for editing. You can do this by running the following command:
```bash
crontab -e
```

2. Add the following line to the crontab file:
`0 20 * * * bash /srv/genus-wfm/backups/backup.sh`
This will run the backup script daily at 8PM.

3. Save and close the crontab file.

4. Restart the cron service. You can do this by running the following command:
```bash
sudo systemctl restart cron
```

## Samba 
To add a user named sahres follow below steps

1. Create a new group with the command 
```bash
sudo addgroup smbgrp
```
2. Create a new user with the command
```bash
sudo useradd shares -G smbgrp
```
3. Create a Samba password for the user with the command
```bash
sudo smbpasswd -a shares
```
4. Now, open the /etc/samba/smb.conf file, and add the following under the Share Definitions or at the bottom of the file:

```
[postgres_dump]
path = /srv/genus-wfm/backups/postgres_dump
available = yes
valid users = @smbgrp
browseable = yes
writable = yes
read only = no
```

```
[attachment_dump]
path = /srv/genus-wfm/backups/attachment_dump
available = yes
valid users = @smbgrp
browseable = yes
writable = yes
read only = no
```